# Using SDEverywhere to Make a Vensim Model into a Web Application

Revised: 2019-01-23

This tutorial shows you how to take your Vensim model and turn it into an interactive web application using the open-source SDEverywhere toolkit. SDEverywhere currently requires the macOS operating system.

## Getting started

### Install a development web server (optional)

You can run the generated web app from any web server. If you need a simple web server on your development machine, install `serve` globally.
~~~
npm install serve -g
~~~

### Install the Java JDK

The Emscripten compiler uses Java to run the Google Closure compiler, which shrinks generated JavaScript code size considerably. Download and install the JDK from the [Oracle download page](https://www.oracle.com/technetwork/java/javase/downloads/index.html).

### Set up Emscripten

The Emscripten SDK is a tool that converts the C code generated by SDEverywhere into JavaScript, and then compiles it into WebAssembly that runs in a browser.

1. Download the latest [Emscripten SDK release](https://github.com/emscripten-core/emsdk/archive/master.zip).

2. Unzip `emsdk-master.zip`. Rename the `emsdk-master` directory to `emsdk` in a location of your choice. Go to that directory in your terminal.

3. Install and activate the SDK.
~~~
./emsdk update
./emsdk install latest
./emsdk activate latest
~~~

4. Note the recommended PATH printed by the last command, which will look something like this, depending on where you installed Emscripten:
~~~
/Users/todd/src/emsdk:/Users/todd/src/emsdk/clang/e1.38.25_64bit:/Users/todd/src/emsdk/node/8.9.1_64bit/bin:/Users/todd/src/emsdk/emscripten/1.38.25
~~~

5. Copy the PATH line. Remove the clang and node directories from the PATH. (They are second and third directories in the colon-delimited list.)

6. Add the Emscripten SDK to your PATH in `~/.bash_profile` like this:
~~~
# Set up Emscripten
export PATH="/Users/todd/src/emsdk:/Users/todd/src/emsdk/emscripten/1.38.25:$PATH"
~~~

7. Close your terminal window. Reopen it, and check if the Emscripten compiler is now available.
~~~
emcc -v
~~~

## Generating model code and validating it

The first step generates C code for your model and validates it against a Vensim run. This is necessary to ensure that SDEverywhere can handle all the Vensim constructs in your model and that it generates correct code for your equations. In a later step, the C code will be converted to JavaScript code that will be embedded in your web app.

Create a model directory.

Copy the model `.mdl` file into the model directory using a short, lower-case name, since you will be typing it in SDEverywhere commands. The placeholder for the model name (without the `.mdl` extension) in these instructions is `{model}`.

Run the model in Vensim using `{model}` as the run name.

Export the `.vdf` run in Vensim DAT format using Model > Export Dataset.

Generate C code, compile and run it, and validate the results against Vensim.
~~~
sde test {model}
~~~

SDEverywhere will list discrepancies between the Vensim run and data generated by the C model, up to a default precision of 10<sup>-5</sup>. If you are getting errors and somewhat less precision, such as 10<sup>-3</sup>, is acceptable, run the test with the `-p` option.

~~~
sde test -p 1e-3 {model}
~~~

## Designing your web app

SDEverywhere generates a web application based on a standard template. You fill in the template by creating an `app.yaml` file in [YAML](http://nodeca.github.io/js-yaml/) format. Use a plain text editor such as [Atom](https://atom.io/) to create the file, starting from the `app-sample.yaml` file in the SDEverywhere `notes` directory. Refer to the *SDEverywhere Web App YAML Format Reference* document for details. There is a fully worked-out example in the `models/sir` directory. Place the `app.yaml` file in your model directory.

## Generating the web app

Generate WebAssembly code for the model and embed it in a web app.
~~~
sde generate --genhtml {model}
~~~

If you installed the Node-based `serve`, start it, and then open the web app with the URL it prints.
~~~
serve build/web
~~~

If you are using your own web server, configure it to serve files from the `build/web` directory under the model directory.

The files to deploy to a web server in production are found in the `build/web` directory.
